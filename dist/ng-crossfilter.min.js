/*! ng-crossfilter by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-06-09 */
!function(a,b,c,d,e,f){"use strict";var g=function(a){throw"ngCrossfilter: "+a+"."};"undefined"==typeof a&&g("Angular dependency is a requirement"),"undefined"==typeof b&&g("Crossfilter dependency is a requirement");var h=a.module("ngCrossfilter",[]);h.service("Crossfilter",["$rootScope","$timeout","$window",function(h,i,j){var k=function(a,b,c,d){this.filters.HAS_UNDERSCORE="undefined"!=typeof f,this.filters._isArray=this._isArray,this._resetAll(),this._initialise(a,b,c,d),this._applyChanges();var e=[];return e.length=a.length,e.__proto__=this,e};return k.prototype=[],k.prototype.STRATEGY_PERSISTENT="persistent",k.prototype.STRATEGY_TRANSIENT="transient",k.prototype.PRIMARY_DIMENSION="__primaryKey",k.prototype._crossfilter={},k.prototype._cacheGroups={},k.prototype._dimensions=[],k.prototype._primaryKey="",k.prototype._sortProperty="",k.prototype._isAscending=!0,k.prototype._lastFilter="",k.prototype._strategy="",k.prototype._debug=!1,k.prototype.filters={HAS_UNDERSCORE:!1,fuzzy:function(a){return function(b,c){var d=new j.RegExp(b,a);return!!c.match(d)}},dateTimeRange:function(a){return function(b,c){"undefined"==typeof e&&g("You need to install Moment.js to use dateTimeRange");var d=e(b[0],a).unix(),f=e(b[1],a).unix(),h=e(c,a).unix();return(0>d||0>f||0>h)&&g("Date/Time parsing appears to be using invalid format"),h>=d&&f>=h}},regexp:function(){return function(a,b){return a instanceof j.RegExp||g("Expression must be an instance of RegExp"),!!b.match(a)}},bitwise:function(a){return function(b,c){return"!"===a?!(b&c):b&c}},inArray:function(a){var b=this.HAS_UNDERSCORE,c=this._isArray;return function(d,e){c(e)||g("Using inArray filter on a non-array like property"),c(d)||(d=[d]),a=a||"every",a&&-1===["every","some"].indexOf(a)&&g("You must pass either 'every' or 'some'"),b||"function"==typeof[].every&&"function"==typeof[].some||g("Browser does not support `every` and/or `some` methods");var h=function(a){return-1!==e.indexOf(a)};return b?f[a](d,h):d[a](h)}}},k.prototype._initialise=function(c,d,e,f){this._isArray(c)||g("Collection must be an array"),e=e||this.STRATEGY_PERSISTENT,-1===[this.STRATEGY_PERSISTENT,this.STRATEGY_TRANSIENT].indexOf(e)&&g("Strategy must be either '"+this.STRATEGY_PERSISTENT+"' or '"+this.STRATEGY_TRANSIENT+"'"),!d||d in c[0]||g("Primary key '"+d+"' is not in the collection"),f=f||this._getProperties(c[0]),this._crossfilter=b(c),this._strategy=e,this._primaryKey=d||f[0];var h=function(a,b){this._dimensions[a]=this._crossfilter.dimension(function(c){return c[b||a]})}.bind(this);a.forEach(f,function(a){h(a)}.bind(this)),h(this.PRIMARY_DIMENSION,this._primaryKey),this._broadcastChanges(!0)},k.prototype.filterBy=function(a,b,c){if(this._assertDimensionExists(a),"undefined"!=typeof c&&"function"!=typeof c)throw g("Custom filter method must be a function");return this._prepareChanges(),this._lastFilter&&this._strategy===this.STRATEGY_TRANSIENT&&this.unfilterBy(this._lastFilter),this._lastFilter=a,"function"==typeof c?(this._dimensions[a].filterFunction(function(a){return c(b,a)}),void this._applyChanges()):(this._dimensions[a].filter(b),void this._applyChanges())},k.prototype.unfilterBy=function(a){this._assertDimensionExists(a),this._prepareChanges(),this._dimensions[a].filterAll(),this._applyChanges()},k.prototype.unfilterAll=function(){this._prepareChanges();for(var a in this._dimensions)this._dimensions.hasOwnProperty(a)&&this._dimensions[a].filterAll();this._applyChanges()},k.prototype.sortBy=function(a,b){if(this._assertDimensionExists(a),this._prepareChanges(),"boolean"==typeof b)return this._isAscending=b,this._sortProperty=a,void this._applyChanges();var c=this._sortProperty||this._primaryKey;c===a&&(this._isAscending=!this._isAscending),this._sortProperty=a,this._applyChanges()},k.prototype.unsortBy=function(a,b){this._assertDimensionExists(a),this._prepareChanges(),this._sortProperty!==a&&g("Currently not sorting by property '"+a+"'"),this._sortProperty=this._primaryKey,b!==!0&&(this._isAscending=!0),this._applyChanges()},k.prototype.addDimension=function(a,b){this._assertValidDimensionName(a),this._dimensions[a]=this._crossfilter.dimension(b)},k.prototype.deleteDimension=function(a){this._assertDimensionExists(a),this._dimensions[a].dispose(),delete this._dimensions[a]},k.prototype.first=function(){return this[0]},k.prototype.last=function(){return this[this.length-1]},k.prototype.countBy=function(a,b){if(this._cacheGroups[a])return this._cacheGroups[a][b]||0;crossfilter._debug&&d.time("timeTaken"),this._assertDimensionExists(a);var c={},e=this._dimensions[a].group().all();for(var f in e)if(e.hasOwnProperty(f)){var g=e[f];c[g.key]=g.value}return this._cacheGroups[a]=c,crossfilter._debug&&d.timeEnd("timeTaken"),c[b]||0},k.prototype.groupBy=function(a){return this._assertDimensionExists(a),this._dimensions[a].group(function(a){return a}).all()},k.prototype.addModel=function(a){return this.addModels([a])},k.prototype.addModels=function(a){return this._crossfilter.add(a),this._applyChanges(),a.length},k.prototype.deleteModel=function(a){return this.deleteModels([a])},k.prototype.deleteModels=function(b){var c=[];return a.forEach(b,function(a){var b=a[this._primaryKey];"undefined"==typeof b&&g("Unable to find the primary key in model: '"+this._primaryKey+"'"),c.push(b)}.bind(this)),this._dimensions[this.PRIMARY_DIMENSION].filter(function(a){return-1===c.indexOf(a)}),this._applyChanges(),c.length},k.prototype.debugMode=function(a){this._debug=!!a},k.prototype._getCollection=function(a){var b=this._sortProperty||this._primaryKey,c=this._isAscending?"bottom":"top";return"undefined"==typeof this._dimensions[b]?this:this._dimensions[b][c](a||1/0)},k.prototype._prepareChanges=function(){this._debug&&d.time("timeTaken"),this._cacheGroups={},this._broadcastChanges()},k.prototype._applyChanges=function(){this.length=0;var a=this._getCollection();for(var b in a)a.hasOwnProperty(b)&&this.push(a[b]);this._debug&&d.timeEnd("timeTaken")},k.prototype._broadcastChanges=function(a){var b=function(){h.$broadcast("crossfilter/updated")};return a?void i(b,1):void b()},k.prototype._assertDimensionExists=function(a){"undefined"==typeof this._dimensions[a]&&g("Unable to find dimension named '"+a+"'")},k.prototype._assertValidDimensionName=function(a){a===this.PRIMARY_DIMENSION&&g("Cannot define dimension using special dimension: '"+this.PRIMARY_DIMENSION+"'");for(var b in this._dimensions)b===a&&g("Cannot overwrite an existing dimension: '"+b+"'")},k.prototype._getProperties=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},k.prototype._isArray=function(a){return"function"==typeof c.isArray?c.isArray(a):"undefined"!=typeof f?f.isArray(a):"[object Array]"==typeof a},k.prototype._resetAll=function(){this._crossfilter={},this._cacheGroups={},this._dimensions={}},k.prototype.toString=function(){return"[object Array]"},k}])}(window.angular,window.crossfilter,window.Array,window.console,window.moment,window._);