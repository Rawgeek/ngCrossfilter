/*! ng-crossfilter by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-06-03 */
!function(a,b,c,d,e){"use strict";var f=function(a){throw"ngCrossfilter: "+a+"."};"undefined"==typeof a&&f("Angular dependency is a requirement"),"undefined"==typeof b&&f("Crossfilter dependency is a requirement");var g=a.module("ngCrossfilter",[]);g.filter("crossfilter",function(){return function(a){if("undefined"==typeof a._collection)return a;if(a._cacheCollection.length&&a._iterations.current===a._iterations.previous)return a._cacheCollection;a._debug&&d.time("timeTaken");var b=a.getCollection();return a._cacheCollection=b,a._iterations.previous=a._iterations.current,a._debug&&d.timeEnd("timeTaken"),b}}),g.service("Crossfilter",["$rootScope","$timeout","$window",function(g,h,i){var j=function(a,b,c,d){this._resetAll(),this._initialise(a,b,c,d)};return j.prototype={STRATEGY_PERSISTENT:"persistent",STRATEGY_TRANSIENT:"transient",PRIMARY_DIMENSION:"__primaryKey",_collection:{},_cacheCollection:[],_cacheGroups:{},_dimensions:[],_primaryKey:"",_sortProperty:"",_isAscending:!0,_lastFilter:"",_strategy:"",_iterations:{current:1,previous:1},_debug:!1,filters:{fuzzy:function(a){return function(b,c){var d=new i.RegExp(b,a);return!!c.match(d)}},dateTimeRange:function(a){return function(b,c){"undefined"==typeof e&&f("You need to install Moment.js to use dateTimeRange");var d=e(b[0],a).unix(),g=e(b[1],a).unix(),h=e(c,a).unix();return h>=d&&g>=h}},regexp:function(){return function(a,b){return a instanceof i.RegExp||f("Expression must be an instance of RegExp"),!!b.match(a)}},bitwise:function(a){return function(b,c){return"!"===a?!(b&c):b&c}},inArray:function(a){return function(b,d){return"function"==typeof c.isArray&&(c.isArray(d)||f("Using inArray filter on a non-array like property"),c.isArray(b)||(b=[b])),a&&-1===["every","some"].indexOf(a)&&f("You must pass either 'every' or 'some'"),("function"!=typeof[].every||"function"!=typeof[].some)&&f("Browser does not support `every` and/or `some` methods"),b[a||"every"](function(a){return-1!==d.indexOf(a)})}}},_initialise:function(d,e,g,h){"function"!=typeof c.isArray||c.isArray(d)||f("Collection must be an array"),g=g||this.STRATEGY_PERSISTENT,-1===[this.STRATEGY_PERSISTENT,this.STRATEGY_TRANSIENT].indexOf(g)&&f("Strategy must be either '"+this.STRATEGY_PERSISTENT+"' or '"+this.STRATEGY_TRANSIENT+"'"),!e||e in d[0]||f("Primary key '"+e+"' is not in the collection"),h=h||this._getProperties(d[0]),this._collection=b(d),this._strategy=g,this._primaryKey=e||h[0];var i=function(a,b){this._dimensions[a]=this._collection.dimension(function(c){return c[b||a]})}.bind(this);a.forEach(h,function(a){i(a)}.bind(this)),i(this.PRIMARY_DIMENSION,this._primaryKey),this._broadcastChanges(!0)},filterBy:function(a,b,c){if(this._assertDimensionExists(a),"undefined"!=typeof c&&"function"!=typeof c)throw f("Custom filter method must be a function");return this._prepareChanges(),this._lastFilter&&this._strategy===this.STRATEGY_TRANSIENT&&this.unfilterBy(this._lastFilter),this._lastFilter=a,"function"==typeof c?void this._dimensions[a].filterFunction(function(a){return c(b,a)}):void this._dimensions[a].filter(b)},unfilterBy:function(a){this._assertDimensionExists(a),this._prepareChanges(),this._dimensions[a].filterAll()},unfilterAll:function(){this._prepareChanges();for(var a in this._dimensions)this._dimensions.hasOwnProperty(a)&&this._dimensions[a].filterAll()},sortBy:function(a,b){if(this._assertDimensionExists(a),this._prepareChanges(),"boolean"==typeof b)return this._isAscending=b,void(this._sortProperty=a);var c=this._sortProperty||this._primaryKey;c===a&&(this._isAscending=!this._isAscending),this._sortProperty=a},unsortBy:function(a,b){this._assertDimensionExists(a),this._prepareChanges(),this._sortProperty!==a&&f("Currently not sorting by property '"+a+"'"),this._sortProperty=this._primaryKey,b!==!0&&(this._isAscending=!0)},addDimension:function(a,b){this._assertValidDimensionName(a),this._dimensions[a]=this._collection.dimension(b)},deleteDimension:function(a){this._assertDimensionExists(a),this._dimensions[a].dispose(),delete this._dimensions[a]},getCollection:function(){var a=this._sortProperty||this._primaryKey,b=this._isAscending?"bottom":"top";return this._dimensions[a][b](1/0)},getFirst:function(){return this.getModel(0)},getLast:function(){return this.getModel(this.getCount()-1)},getModel:function(a){return this.getCollection()[a]},getModels:function(){return this.getCollection()},countBy:function(a,b){if(this._cacheGroups[a])return this._cacheGroups[a][b]||0;crossfilter._debug&&d.time("timeTaken"),this._assertDimensionExists(a);var c={},e=this._dimensions[a].group().all();for(var f in e)if(e.hasOwnProperty(f)){var g=e[f];c[g.key]=g.value}return this._cacheGroups[a]=c,crossfilter._debug&&d.timeEnd("timeTaken"),c[b]||0},groupBy:function(a){return this._assertDimensionExists(a),this._dimensions[a].group(function(a){return a}).all()},addModel:function(a){return this.addModels([a])},addModels:function(a){return this._collection.add(a),a.length},deleteModel:function(a){return this.deleteModels([a])},deleteModels:function(b){var c=[];return a.forEach(b,function(a){var b=a[this._primaryKey];"undefined"==typeof b&&f("Unable to find the primary key in model: '"+this._primaryKey+"'"),c.push(b)}.bind(this)),this._dimensions[this.PRIMARY_DIMENSION].filter(function(a){return-1===c.indexOf(a)}),c.length},getCount:function(){return this._cacheCollection.length||this.getCollection().length},debugMode:function(a){this._debug=!!a},_prepareChanges:function(){this._cacheGroups={},this._iterations.current++,this._broadcastChanges()},_broadcastChanges:function(a){var b=function(){g.$broadcast("crossfilter/updated")};return a?void h(b,1):void b()},_assertDimensionExists:function(a){"undefined"==typeof this._dimensions[a]&&f("Unable to find dimension named '"+a+"'")},_assertValidDimensionName:function(a){a===this.PRIMARY_DIMENSION&&f("Cannot define dimension using special dimension: '"+this.PRIMARY_DIMENSION+"'");for(var b in this._dimensions)b===a&&f("Cannot overwrite an existing dimension: '"+b+"'")},_getProperties:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},_resetAll:function(){this._collection={},this._cacheCollection=[],this._cacheGroups={},this._dimensions={},this._iterations={current:1,previous:1}}},j}])}(window.angular,window.crossfilter,window.Array,window.console,window.moment);