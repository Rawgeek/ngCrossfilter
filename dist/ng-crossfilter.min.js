/*! ng-crossfilter by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-06-18 */
!function(a,b,c,d){"use strict";var e=function(a){throw"ngCrossfilter: "+a+"."};"undefined"==typeof a&&e("ngCrossfilter Requires Angular.js"),"undefined"==typeof b&&e("ngCrossfilter Requires Crossfilter");var f=a.module("ngCrossfilter",[]);f.service("Crossfilter",["$rootScope","$timeout","$window",function(f,g,h){var i=function(a,b,c,e){this.filters.HAS_UNDERSCORE="undefined"!=typeof d,this.filters._isArray=this._isArray,this._resetAll(),this._initialise(a,b,c,e),this._applyChanges();var f=[];return f.length=a.length,f.__proto__=this,f};return i.prototype=[],i.prototype.STRATEGY_PERSISTENT="persistent",i.prototype.STRATEGY_TRANSIENT="transient",i.prototype.PRIMARY_DIMENSION="__primaryKey",i.prototype._crossfilter={},i.prototype._cacheGroups={},i.prototype._isTiming=!1,i.prototype._dimensions={},i.prototype._primaryKey="",i.prototype._sortProperty="",i.prototype._isAscending=!0,i.prototype._lastFilter="",i.prototype._strategy="",i.prototype._debug=!1,i.prototype.filters={HAS_UNDERSCORE:!1,fuzzy:function(a){return function(b,c){var d=new h.RegExp(b,a);return!!c.match(d)}},dateTimeRange:function(a,b){return"undefined"==typeof c&&e("You need to install Moment.js to use dateTimeRange"),function(d,f){var g=d[0]===-1/0?0:c(d[0],a).unix(),h=1/0===d[1]?1/0:c(d[1],a).unix(),i=c(f,a).unix();return(0>g||0>h||0>i)&&e("Date/Time parsing appears to be using invalid format"),"function"==typeof b?b(i,g,h):i>=g&&h>=i}},regexp:function(){return function(a,b){return a instanceof h.RegExp||e("Expression must be an instance of RegExp"),!!b.match(a)}},bitwise:function(a){return function(b,c){var d=b&c;return"!"===a?!d:d}},inArray:function(a){return this._inArray(a)},notInArray:function(a){return this._inArray(a,!0)},_inArray:function(a,b){var c=this.HAS_UNDERSCORE,f=this._isArray;return function(g,h){f(h)||e("Using inArray filter on a non-array like property"),f(g)||(g=[g]),a=a||"every",a&&-1===["every","some"].indexOf(a)&&e("You must pass either 'every' or 'some'"),c||"function"==typeof[].every&&"function"==typeof[].some||e("Browser does not support `every` and/or `some` methods");var i=function(a){var c=-1!==h.indexOf(a);return b?!c:c};return c?d[a](g,i):g[a](i)}}},i.prototype._initialise=function(c,d,f,g){this._isArray(c)||e("Collection must be an array"),f=f||this.STRATEGY_PERSISTENT,-1===[this.STRATEGY_PERSISTENT,this.STRATEGY_TRANSIENT].indexOf(f)&&e("Strategy must be either '"+this.STRATEGY_PERSISTENT+"' or '"+this.STRATEGY_TRANSIENT+"'"),!d||d in c[0]||e("Primary key '"+d+"' is not in the collection"),g=g||this._getProperties(c[0]),this._crossfilter=b(c),this._strategy=f,this._primaryKey=d||g[0];var h=function(a,b){this._dimensions[a]=this._crossfilter.dimension(function(c){return c[b||a]})}.bind(this);a.forEach(g,function(a){h(a)}.bind(this)),h(this.PRIMARY_DIMENSION,this._primaryKey),this._broadcastChanges(!0)},i.prototype.filterBy=function(a,b,c){if(this._assertDimensionExists(a),"undefined"!=typeof c&&"function"!=typeof c)throw e("Custom filter method must be a function");return this._prepareChanges(),this._lastFilter&&this._strategy===this.STRATEGY_TRANSIENT&&this.unfilterBy(this._lastFilter),this._lastFilter=a,"function"==typeof c?(this._dimensions[a].filterFunction(function(a){return c(b,a)}),void this._applyChanges()):(this._dimensions[a].filter(b),void this._applyChanges())},i.prototype.unfilterBy=function(a){this._assertDimensionExists(a),this._prepareChanges(),this._dimensions[a].filterAll(),this._applyChanges()},i.prototype.unfilterAll=function(){this._prepareChanges();for(var a in this._dimensions)this._dimensions.hasOwnProperty(a)&&this._dimensions[a].filterAll();this._applyChanges()},i.prototype.sortBy=function(a,b){if(this._assertDimensionExists(a),this._prepareChanges(),"boolean"==typeof b)return this._isAscending=b,this._sortProperty=a,void this._applyChanges();var c=this._sortProperty||this._primaryKey;c===a&&(this._isAscending=!this._isAscending),this._sortProperty=a,this._applyChanges()},i.prototype.unsortAll=function(a){this._prepareChanges(),this._sortProperty=this._primaryKey,a!==!0&&(this._isAscending=!0),this._applyChanges()},i.prototype.addDimension=function(a,b){b=b||function(b){return b[a]},this._assertValidDimensionName(a),this._dimensions[a]=this._crossfilter.dimension(b)},i.prototype.deleteDimension=function(a){this._assertDimensionExists(a),this._dimensions[a].dispose(),delete this._dimensions[a]},i.prototype.first=function(){return this[0]},i.prototype.last=function(){return this[this.length-1]},i.prototype.countBy=function(a,b){if(this._cacheGroups[a])return this._cacheGroups[a][b]||0;this._timerManager(),this._assertDimensionExists(a);var c={},d=this._dimensions[a].group().all();for(var e in d)if(d.hasOwnProperty(e)){var f=d[e];c[f.key]=f.value}return this._cacheGroups[a]=c,this._timerManager(),c[b]||0},i.prototype.groupBy=function(a){return this._assertDimensionExists(a),this._dimensions[a].group(function(a){return a}).all()},i.prototype.models=function(a,b){var c=this._collection("number"==typeof b?b:1/0);return c.splice("number"==typeof a?a:1/0)},i.prototype.addModel=function(a){return this.addModels([a])},i.prototype.addModels=function(a){return this._crossfilter.add(a),this._applyChanges(),a.length},i.prototype.deleteModel=function(a){return this.deleteModels([a])},i.prototype.deleteModels=function(b){var c=[];return a.forEach(b,function(a){var b=a[this._primaryKey];"undefined"==typeof b&&e("Unable to find the primary key in model: '"+this._primaryKey+"'"),c.push(b)}.bind(this)),this._dimensions[this.PRIMARY_DIMENSION].filter(function(a){return-1===c.indexOf(a)}),this._applyChanges(),c.length},i.prototype.debugMode=function(a){this._debug=!!a},i.prototype.crossfilter=function(){return this._crossfilter},i.prototype._collection=function(a){var b=this._sortProperty||this._primaryKey,c=this._isAscending?"bottom":"top";return"undefined"==typeof this._dimensions[b]?this:this._dimensions[b][c](a||1/0)},i.prototype._prepareChanges=function(){this._timerManager(),this._cacheGroups={},this._broadcastChanges()},i.prototype._applyChanges=function(){this.length=0;var a=this._collection(1/0);for(var b in a)a.hasOwnProperty(b)&&this.push(a[b]);this._timerManager()},i.prototype._broadcastChanges=function(a){var b=function(){f.$broadcast("crossfilter/updated")};return a?void g(b,1):void b()},i.prototype._assertDimensionExists=function(a){"undefined"==typeof this._dimensions[a]&&e("Unable to find dimension named '"+a+"'")},i.prototype._assertValidDimensionName=function(a){a===this.PRIMARY_DIMENSION&&e("Cannot define dimension using special dimension: '"+this.PRIMARY_DIMENSION+"'");for(var b in this._dimensions)b===a&&e("Cannot overwrite an existing dimension: '"+b+"'")},i.prototype._timerManager=function(){if(this._debug){var a=this._isTiming?"time":"timeEnd";this._isTiming=!this._isTiming,h.console[a]("timeTaken")}},i.prototype._getProperties=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},i.prototype._isArray=function(a){return"function"==typeof h.Array.isArray?h.Array.isArray(a):"undefined"!=typeof d?d.isArray(a):"[object Array]"==typeof a},i.prototype._resetAll=function(){this._crossfilter={},this._cacheGroups={},this._dimensions={}},i.prototype.toString=function(){return"[object Array]"},i}])}(window.angular,window.crossfilter,window.moment,window._);