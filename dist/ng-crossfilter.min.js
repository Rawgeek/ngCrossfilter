/*! ng-crossfilter by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-06-09 */
!function(a,b,c,d){"use strict";var e=function(a){throw"ngCrossfilter: "+a+"."};"undefined"==typeof a&&e("Requires Angular.js: https://angularjs.org/"),"undefined"==typeof b&&e("Requires Crossfilter: https://github.com/square/crossfilter");var f=a.module("ngCrossfilter",[]);f.service("Crossfilter",["$rootScope","$timeout","$window",function(f,g,h){var i=function(a,b,c,e){this.filters.HAS_UNDERSCORE="undefined"!=typeof d,this.filters._isArray=this._isArray,this._resetAll(),this._initialise(a,b,c,e),this._applyChanges();var f=[];return f.length=a.length,f.__proto__=this,f};return i.prototype=[],i.prototype.STRATEGY_PERSISTENT="persistent",i.prototype.STRATEGY_TRANSIENT="transient",i.prototype.PRIMARY_DIMENSION="__primaryKey",i.prototype._crossfilter={},i.prototype._cacheGroups={},i.prototype._dimensions={},i.prototype._primaryKey="",i.prototype._sortProperty="",i.prototype._isAscending=!0,i.prototype._lastFilter="",i.prototype._strategy="",i.prototype._debug=!1,i.prototype.filters={HAS_UNDERSCORE:!1,fuzzy:function(a){return function(b,c){var d=new h.RegExp(b,a);return!!c.match(d)}},dateTimeRange:function(a){return"undefined"==typeof c&&e("You need to install Moment.js to use dateTimeRange"),function(b,d){var f=b[0]===-1/0?0:c(b[0],a).unix(),g=1/0===b[1]?1/0:c(b[1],a).unix(),h=c(d,a).unix();return(0>f||0>g||0>h)&&e("Date/Time parsing appears to be using invalid format"),h>=f&&g>=h}},regexp:function(){return function(a,b){return a instanceof h.RegExp||e("Expression must be an instance of RegExp"),!!b.match(a)}},bitwise:function(a){return function(b,c){var d=b&c;return"!"===a?!d:d}},inArray:function(a){var b=this.HAS_UNDERSCORE,c=this._isArray;return function(f,g){c(g)||e("Using inArray filter on a non-array like property"),c(f)||(f=[f]),a=a||"every",a&&-1===["every","some"].indexOf(a)&&e("You must pass either 'every' or 'some'"),b||"function"==typeof[].every&&"function"==typeof[].some||e("Browser does not support `every` and/or `some` methods");var h=function(a){return-1!==g.indexOf(a)};return b?d[a](f,h):f[a](h)}}},i.prototype._initialise=function(c,d,f,g){this._isArray(c)||e("Collection must be an array"),f=f||this.STRATEGY_PERSISTENT,-1===[this.STRATEGY_PERSISTENT,this.STRATEGY_TRANSIENT].indexOf(f)&&e("Strategy must be either '"+this.STRATEGY_PERSISTENT+"' or '"+this.STRATEGY_TRANSIENT+"'"),!d||d in c[0]||e("Primary key '"+d+"' is not in the collection"),g=g||this._getProperties(c[0]),this._crossfilter=b(c),this._strategy=f,this._primaryKey=d||g[0];var h=function(a,b){this._dimensions[a]=this._crossfilter.dimension(function(c){return c[b||a]})}.bind(this);a.forEach(g,function(a){h(a)}.bind(this)),h(this.PRIMARY_DIMENSION,this._primaryKey),this._broadcastChanges(!0)},i.prototype.filterBy=function(a,b,c){if(this._assertDimensionExists(a),"undefined"!=typeof c&&"function"!=typeof c)throw e("Custom filter method must be a function");return this._prepareChanges(),this._lastFilter&&this._strategy===this.STRATEGY_TRANSIENT&&this.unfilterBy(this._lastFilter),this._lastFilter=a,"function"==typeof c?(this._dimensions[a].filterFunction(function(a){return c(b,a)}),void this._applyChanges()):(this._dimensions[a].filter(b),void this._applyChanges())},i.prototype.unfilterBy=function(a){this._assertDimensionExists(a),this._prepareChanges(),this._dimensions[a].filterAll(),this._applyChanges()},i.prototype.unfilterAll=function(){this._prepareChanges();for(var a in this._dimensions)this._dimensions.hasOwnProperty(a)&&this._dimensions[a].filterAll();this._applyChanges()},i.prototype.sortBy=function(a,b){if(this._assertDimensionExists(a),this._prepareChanges(),"boolean"==typeof b)return this._isAscending=b,this._sortProperty=a,void this._applyChanges();var c=this._sortProperty||this._primaryKey;c===a&&(this._isAscending=!this._isAscending),this._sortProperty=a,this._applyChanges()},i.prototype.unsortBy=function(a,b){this._assertDimensionExists(a),this._prepareChanges(),this._sortProperty!==a&&e("Currently not sorting by property '"+a+"'"),this._sortProperty=this._primaryKey,b!==!0&&(this._isAscending=!0),this._applyChanges()},i.prototype.addDimension=function(a,b){this._assertValidDimensionName(a),this._dimensions[a]=this._crossfilter.dimension(b)},i.prototype.deleteDimension=function(a){this._assertDimensionExists(a),this._dimensions[a].dispose(),delete this._dimensions[a]},i.prototype.first=function(){return this[0]},i.prototype.last=function(){return this[this.length-1]},i.prototype.countBy=function(a,b){if(this._cacheGroups[a])return this._cacheGroups[a][b]||0;this._debug&&h.console.time("timeTaken"),this._assertDimensionExists(a);var c={},d=this._dimensions[a].group().all();for(var e in d)if(d.hasOwnProperty(e)){var f=d[e];c[f.key]=f.value}return this._cacheGroups[a]=c,this._debug&&h.console.timeEnd("timeTaken"),c[b]||0},i.prototype.groupBy=function(a){return this._assertDimensionExists(a),this._dimensions[a].group(function(a){return a}).all()},i.prototype.addModel=function(a){return this.addModels([a])},i.prototype.addModels=function(a){return this._crossfilter.add(a),this._applyChanges(),a.length},i.prototype.deleteModel=function(a){return this.deleteModels([a])},i.prototype.deleteModels=function(b){var c=[];return a.forEach(b,function(a){var b=a[this._primaryKey];"undefined"==typeof b&&e("Unable to find the primary key in model: '"+this._primaryKey+"'"),c.push(b)}.bind(this)),this._dimensions[this.PRIMARY_DIMENSION].filter(function(a){return-1===c.indexOf(a)}),this._applyChanges(),c.length},i.prototype.debugMode=function(a){this._debug=!!a},i.prototype._getCollection=function(a){var b=this._sortProperty||this._primaryKey,c=this._isAscending?"bottom":"top";return"undefined"==typeof this._dimensions[b]?this:this._dimensions[b][c](a||1/0)},i.prototype._prepareChanges=function(){this._debug&&h.console.time("timeTaken"),this._cacheGroups={},this._broadcastChanges()},i.prototype._applyChanges=function(){this.length=0;var a=this._getCollection();for(var b in a)a.hasOwnProperty(b)&&this.push(a[b]);this._debug&&h.console.timeEnd("timeTaken")},i.prototype._broadcastChanges=function(a){var b=function(){f.$broadcast("crossfilter/updated")};return a?void g(b,1):void b()},i.prototype._assertDimensionExists=function(a){"undefined"==typeof this._dimensions[a]&&e("Unable to find dimension named '"+a+"'")},i.prototype._assertValidDimensionName=function(a){a===this.PRIMARY_DIMENSION&&e("Cannot define dimension using special dimension: '"+this.PRIMARY_DIMENSION+"'");for(var b in this._dimensions)b===a&&e("Cannot overwrite an existing dimension: '"+b+"'")},i.prototype._getProperties=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},i.prototype._isArray=function(a){return"function"==typeof h.Array.isArray?h.Array.isArray(a):"undefined"!=typeof d?d.isArray(a):"[object Array]"==typeof a},i.prototype._resetAll=function(){this._crossfilter={},this._cacheGroups={},this._dimensions={}},i.prototype.toString=function(){return"[object Array]"},i}])}(window.angular,window.crossfilter,window.moment,window._);